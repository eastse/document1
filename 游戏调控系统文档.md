# 游戏调控系统详细说明文档

## 目录

1. [系统概述](#系统概述)
2. [核心数据结构](#核心数据结构)
3. [投注模式链路详细说明](#投注模式链路详细说明)
4. [RTP类型计算详解](#rtp类型计算详解)
5. [权重计算方法详解](#权重计算方法详解)
6. [游戏结果生成与缩放](#游戏结果生成与缩放)
7. [重要函数与文件索引](#重要函数与文件索引)
8. [配置说明](#配置说明)

---

## 系统概述

游戏调控系统是根据不同的投注模式、用户状态、商户配置等因素，动态计算游戏的RTP（Return To Player，玩家回报率）并生成相应的游戏结果。

### 系统架构图

```
用户请求 (SpinReq)
    ↓
[游戏模式识别] → GameModeCategory + GameBetMode
    ↓
[计算调整请求] → AdjustRequest
    ↓
[RTP类型计算] → rtpType (HIGH/MIDDLE/LOW)
    ↓
[权重结果计算] → WeightResult
    ↓
[生成游戏结果] → BoardResult
```

---

## 核心数据结构

### 1. AdjustRequest（调整请求）
**文件位置：** [module/jili-game-server/internal/entity/adjust.go](../../../module/jili-game-server/internal/entity/adjust.go)

```go
type AdjustRequest struct {
    BaseRequest    // 基础请求信息
    UserAdjust     *UserAdjust     // 用户调整信息
    MerchantAdjust *MerchantAdjust // 商户调整信息
    MerchantPool   *model.AdjustPoolModel // 商户资金池
    AdjustConfig   *AdjustConfig   // 调整配置
}
```

**字段说明：**
- `Cost`: 本次投注成本
- `BaseBet`: 基础投注额
- `GameCode`: 游戏代码
- `GameMode`: 游戏模式类别（Normal/Card/BuyFeature/Extra）
- `GameBetMode`: 投注模式（NormalBet/CardBet/BuyFeatureBet01等）
- `UserItemView`: 卡片模式下的用户道具信息

### 2. MerchantAdjust（商户调整信息）

```go
type MerchantAdjust struct {
    MerchantRtpStatus       int     // 商户RTP状态（启用/禁用）
    MerchantRtp             float64 // 商户RTP值
    DynamicRealExchangeRate float64 // 动态汇率
    AdjustID                int     // 调控ID
    WeightID                int     // 权重ID
}
```

### 3. UserAdjust（用户调整信息）

```go
type UserAdjust struct {
    UserRtpStatus     int     // 用户RTP状态
    UserRtp           float64 // 用户RTP值
    UserAdjustControl *model.AdjustUserControlModel // 用户调控记录
}
```

### 4. AdjustConfig（调整配置）

```go
type AdjustConfig struct {
    RtpCtrConfig         RtpCtrConfig         // RTP控制配置
    PerformanceCtrConfig PerformanceCtrConfig // 表演控制配置
}

type RtpCtrConfig struct {
    CurrentRtp     float64            // 当前RTP
    RtpType2RtpMap map[string]float64 // RTP类型映射（HIGH/MIDDLE/LOW）
}

type PerformanceCtrConfig struct {
    RtpType2WeightOddsListMap map[string][]WeightOddsPair // RTP类型到权重倍数列表的映射
    WeightPerformanceList     [][]PerformanceWeightPair   // 表演权重列表
}
```

### 5. WeightResult（权重结果）

```go
type WeightResult struct {
    Odds                        float64 // 倍数
    OddsArrayIndex              int     // 倍数数组索引
    PerformanceResultArrayIndex int     // 表演结果数组索引
    PerformanceIndex            int     // 表演索引
}
```

---

## 投注模式链路详细说明

### 投注模式分类

系统支持以下投注模式：

**文件位置：** [module/jili-game-server/serverconst/game.go](../../../module/jili-game-server/serverconst/game.go)

```go
// 游戏模式类别
type GameModeCategory int
const (
    Normal     GameModeCategory = 1 // 普通模式
    Card       GameModeCategory = 2 // 卡片模式
    BuyFeature GameModeCategory = 3 // 购买特色模式
    Extra      GameModeCategory = 4 // 额外投注模式
)

// 投注模式
type GameBetMode int
const (
    NormalBet      GameBetMode = 1 // 普通投注
    CardBet        GameBetMode = 2 // 卡片投注
    BuyFeatureBet01 GameBetMode = 3 // 购买特色投注01
    BuyFeatureBet02 GameBetMode = 4 // 购买特色投注02
    ExtraBet01     GameBetMode = 5 // 额外投注01
    ExtraBet02     GameBetMode = 6 // 额外投注02
)
```

### 1. 普通模式（Normal Mode）链路

**入口函数：** [module/jili-game-server/service/reqservice/spinservice/spin.go](../../../module/jili-game-server/service/reqservice/spinservice/spin.go) - `DoSpin()`

#### 链路流程

```
1. 接收SpinReq请求
   ├─ spinReq.ItemID = 0
   ├─ spinReq.ItemIndex = 0
   ├─ spinReq.MallBet = 0
   └─ spinReq.Extra = 0
   
2. 计算游戏模式
   └─ CalculateGameModeCategoryAndGameBetMode()
      → gameModeCategory = Normal
      → gameBetMode = NormalBet
      
3. 计算投注成本
   └─ CalculateSpinCost()
      → spinCost = spinReq.Bet
      
4. 构建调整请求
   └─ CalculateAdjustRequest()
      ├─ 获取用户信息
      ├─ 获取商户信息
      ├─ 获取商户资金池
      ├─ 获取用户调控信息
      └─ 获取调整配置
      
5. 开始调整处理
   └─ StartAdjust()
      ├─ 计算RTP类型
      │  └─ CalculateRtpType()
      │     ├─ 判断调控模式
      │     │  ├─ AdjustNormalFix（自然不控）
      │     │  ├─ AdjustNormalMerchantDynamic（基本水池）
      │     │  └─ AdjustNormalNewbie（新手扶持）
      │     └─ 使用内插法选择RTP表
      │        └─ ChooseRtpTypeByInterpolation()
      │
      └─ 计算权重结果
         └─ CalculateWeightResult()
            ├─ 根据WeightID选择算法
            │  ├─ WeightNone（原生权重）
            │  ├─ WeightSd1（标准差1）
            │  ├─ WeightSd2（标准差2）
            │  ├─ WeightSd3（标准差3）
            │  ├─ WeightStreamer（直播算法）
            │  └─ WeightFeature（特色算法）
            │
            └─ 计算最终倍数和表演索引
               └─ CalculatePerformanceResultOrigin()
                  ├─ 根据权重随机选择倍数索引
                  └─ 根据权重随机选择表演索引
                  
6. 获取游戏结果模板并缩放
   └─ getTemplateBoardResultAndScale()
      ├─ 根据GameBetMode选择表名
      │  ├─ CardBet → BoardResultCard
      │  ├─ BuyFeatureBet01 → BoardResultBuy
      │  ├─ ExtraBet01 → BoardResultExtra1
      │  ├─ ExtraBet02 → BoardResultExtra2
      │  └─ NormalBet → BoardResultNormal
      │
      ├─ 从ES获取游戏结果模板
      │  └─ GetGameResult(tableName, gameCode, performanceIndex)
      │
      └─ 缩放游戏结果
         └─ scaleTargetBoardResult()
            ├─ 获取缩放路径列表
            ├─ 计算缩放因子
            ├─ 调整投注金额
            ├─ 按比例缩放所有奖励金额
            └─ 返回缩放后的JSON
      
7. 返回游戏结果
```

#### 关键函数说明

**CalculateGameModeCategoryAndGameBetMode**
- **文件：** [module/jili-game-server/service/reqservice/spinservice/gamemodecalculator.go](../../../module/jili-game-server/service/reqservice/spinservice/gamemodecalculator.go)
- **功能：** 根据请求参数判断游戏模式和投注模式
- **逻辑：**
  ```go
  // 判断逻辑
  if spinReq.ItemID != 0 || spinReq.ItemIndex != 0 {
      return Card, CardBet
  } else if spinReq.MallBet != 0 {
      return BuyFeature, BuyFeatureBet01
  } else if spinReq.Extra != 0 {
      return Extra, ExtraBet01/ExtraBet02
  } else {
      return Normal, NormalBet
  }
  ```

**CalculateAdjustRequest**
- **文件：** [module/jili-game-server/service/reqservice/spinservice/adjustmodule.go](../../../module/jili-game-server/service/reqservice/spinservice/adjustmodule.go)
- **功能：** 构建调整请求参数
- **步骤：**
  1. 从上下文获取登录信息、用户信息、商户信息
  2. 获取用户调控记录
  3. 构建BaseRequest（包含成本、投注额、游戏代码等）
  4. 构建MerchantAdjust（商户RTP配置、调控ID、权重ID）
  5. 构建UserAdjust（用户RTP配置、用户调控记录）
  6. 获取AdjustConfig配置
  7. 返回完整的AdjustRequest

### 2. 卡片模式（Card Mode）链路

#### 特殊性说明

卡片模式是一种特殊的投注模式，用户使用卡片道具进行投注，系统根据卡片的价值计算目标RTP。

#### 链路流程

```
1. 接收SpinReq请求
   ├─ spinReq.ItemID ≠ 0 (卡片ID)
   └─ spinReq.ItemIndex ≠ 0 (卡片索引)
   
2. 计算游戏模式
   └─ gameModeCategory = Card
   └─ gameBetMode = CardBet
   
3. 计算投注成本
   └─ spinCost = spinReq.Bet (卡片使用不消耗金币，但有虚拟成本)
   
4. 构建调整请求（包含UserItemView）
   └─ CalculateAdjustRequest()
      └─ 过滤当前使用的卡片信息
         └─ filterCurrentUserItemView()
         
5. 计算RTP类型（卡片专用）
   └─ ChoseRtpTypeWithCard()
      ├─ 计算卡片RTP
      │  └─ CalculateCardRtp()
      │     └─ cardRtp = (DynamicItemValue / DynamicItemBet) / CardOdds
      │
      └─ 使用内插法选择RTP表
         └─ ChooseRtpTypeByInterpolation()
         
6. 计算权重结果（卡片专用）
   └─ CalculateWeightResultCardMode()
      ├─ 计算目标RTP
      ├─ 计算当前权重统计量
      ├─ 调整权重以逼近目标RTP
      │  ├─ 如果当前平均倍数 > 目标RTP
      │  │  └─ calculateWeightOddsListDeductAvgOdds() (消减高倍数权重)
      │  └─ 如果当前平均倍数 < 目标RTP
      │     └─ calculateWeightOddsListAddAvgOdds() (增加高倍数权重)
      │
      └─ 计算最终结果
         └─ CalculatePerformanceResultOrigin()
         
7. 处理卡片道具操作
   └─ OperateActivityUserItemOperate()
      └─ 扣减用户卡片数量
```

#### 卡片RTP计算详解

**CalculateCardRtp**
- **文件：** [module/jili-game-server/service/reqservice/spinservice/adjustcommon/card.go](../../../module/jili-game-server/service/reqservice/spinservice/adjustcommon/card.go)
- **公式：**
  ```
  cardOdds = DynamicItemValue / DynamicItemBet
  cardRtp = cardOdds / CardOdds常数
  ```
  
  其中：
  - `DynamicItemValue`: 卡片的动态价值（玩家购买价格）
  - `DynamicItemBet`: 卡片的动态投注额
  - `CardOdds`: 系统常数，用于归一化

**权重调整算法**

卡片模式需要调整权重表以逼近目标RTP：

1. **消减平均倍数（当前RTP > 目标RTP）**
   - **函数：** `calculateWeightOddsListDeductAvgOdds`
   - **文件：** [module/jili-game-server/service/reqservice/spinservice/weightrtp/weight_card.go](../../../module/jili-game-server/service/reqservice/spinservice/weightrtp/weight_card.go)
   - **逻辑：** 从高倍数开始，逐步减少权重，直到平均倍数逼近目标RTP

2. **增加平均倍数（当前RTP < 目标RTP）**
   - **函数：** `calculateWeightOddsListAddAvgOdds`
   - **逻辑：** 增加高倍数的权重，提升平均倍数

3. **必输模式（逼近失败）**
   - **函数：** `calculatePerformanceResultAbsoluteLoss`
   - **逻辑：** 如果无法逼近目标RTP，强制返回最小奖励
   - **实现：** 将第一个倍数（通常是0倍）的权重设为100，其余设为0

### 3. 购买特色模式（Buy Feature Mode）链路

#### 链路流程

```
1. 接收SpinReq请求
   └─ spinReq.MallBet ≠ 0
   
2. 计算游戏模式
   └─ gameModeCategory = BuyFeature
   └─ gameBetMode = BuyFeatureBet01 (或BuyFeatureBet02)
   
3. 计算投注成本
   └─ spinCost = spinReq.MallBet (购买特色的价格)
   
4. 后续流程与普通模式相同
```

**特点：**
- 投注成本为`MallBet`，通常高于普通投注
- 直接进入特色玩法（如免费旋转、奖金游戏）
- RTP计算和权重选择与普通模式相同

### 4. 额外投注模式（Extra Bet Mode）链路

#### 链路流程

```
1. 接收SpinReq请求
   └─ spinReq.Extra ≠ 0 (1或2)
   
2. 计算游戏模式
   └─ gameModeCategory = Extra
   └─ gameBetMode = ExtraBet01 (Extra=1) 或 ExtraBet02 (Extra=2)
   
3. 计算投注成本（特殊计算）
   └─ calculateExtraBet()
      ├─ 获取倍数列表 CalculateMulList()
      ├─ mulDecimal = mulList[extraBetIndex]
      └─ spinCost = spinReq.Bet × mulDecimal
      
4. 后续流程与普通模式相同
```

**成本计算详解：**

额外投注模式的成本计算较为复杂，涉及倍数列表：

```go
// 例如游戏配置了两种额外投注倍数
mulList = [0.5, 1.5, 2.0]

// ExtraBet01 (Extra=1, Index=1)
spinCost = bet × 1.5

// ExtraBet02 (Extra=2, Index=2)
spinCost = bet × 2.0
```

**ExtraBet01Index** 和 **ExtraBet02Index** 是系统常量，用于索引倍数列表。

---

## RTP类型计算详解

RTP类型是调控系统的核心概念，它决定了使用哪个权重表进行开奖。

### 调控模式（AdjustID）

**文件位置：** [module/jili-game-server/serverconst/game_adjust.go](../../../module/jili-game-server/serverconst/game_adjust.go)

```go
type AdjustID int
const (
    AdjustNormalFix             AdjustID = 1 // 自然不控
    AdjustNormalMerchantDynamic AdjustID = 2 // 基本水池
    AdjustNormalNewbie          AdjustID = 3 // 新手扶持
)
```

### RTP类型计算主函数

**CalculateRtpType**
- **文件：** [module/jili-game-server/service/reqservice/spinservice/adjustmodule.go](../../../module/jili-game-server/service/reqservice/spinservice/adjustmodule.go)
- **逻辑：**
  ```go
  func CalculateRtpType(request *entity.AdjustRequest) string {
      // 1. 卡片模式特殊处理
      if request.GameMode == serverconst.Card {
          return adjustrtp.ChoseRtpTypeWithCard(request)
      }
      
      // 2. 自然不控模式
      if serverconst.AdjustID(request.MerchantAdjust.AdjustID) == serverconst.AdjustNormalFix {
          return adjustrtp.ChoseRtpTypeRandom(request)
      }
      
      // 3. 调控模式
      return adjustrtp.ChoseRtpTypeWithAdjustTypeAndMission(request)
  }
  ```

### 1. 自然不控模式（AdjustNormalFix）

**特点：** 不进行任何调控，使用游戏原始RTP。

**CalculateRtpByAdjustNormalFix**
- **文件：** [module/jili-game-server/service/reqservice/spinservice/adjustrtp/adjust_normal_fix.go](../../../module/jili-game-server/service/reqservice/spinservice/adjustrtp/adjust_normal_fix.go)
- **实现：**
  ```go
  func CalculateRtpByAdjustNormalFix(request *entity.AdjustRequest) float64 {
      return request.AdjustConfig.RtpCtrConfig.CurrentRtp
  }
  ```

**流程：**
```
获取游戏原始RTP
    ↓
使用内插法选择RTP表
    ↓
返回rtpType（HIGH/MIDDLE/LOW）
```

### 2. 基本水池模式（AdjustNormalMerchantDynamic）

**特点：** 根据商户资金池状态动态调整RTP。

**CalculateRtpByAdjustNormalMerchantDynamic**
- **文件：** [module/jili-game-server/service/reqservice/spinservice/adjustrtp/adjust_normal_merchant_dynamic.go](../../../module/jili-game-server/service/reqservice/spinservice/adjustrtp/adjust_normal_merchant_dynamic.go)
- **实现逻辑：**

```go
func CalculateRtpByAdjustNormalMerchantDynamic(request *entity.AdjustRequest) float64 {
    // 1. 确定基础RTP
    gameRtp := 0.0
    if request.MerchantAdjust.MerchantRtpStatus == serverconst.EnableStatusNumber {
        gameRtp = max(request.MerchantAdjust.MerchantRtp, 0.0)
    } else {
        gameRtp = max(request.AdjustConfig.RtpCtrConfig.CurrentRtp, 0.0)
    }
    
    // 2. 水池足够性判断
    merchantPool := request.MerchantPool
    userAdjust := request.UserAdjust
    
    // 计算水池盈余
    poolSurplus = (PoolBet - PoolWin) - (PoolBet × (1 - gameRtp))
    
    if poolSurplus <= 0 {
        // 水池不足，降低RTP
        gameRtp = max(min(gameRtp - 0.2, 0.0), 0.0)
    } else {
        // 水池充足
        if userAdjust.UserRtpStatus == EnableStatusNumber {
            // 使用用户自定义RTP
            gameRtp = userAdjust.UserRtp
        } else {
            // 略微降低RTP
            gameRtp = gameRtp - 0.005
        }
    }
    
    return gameRtp
}
```

**关键判断公式：**

```
水池盈余 = (总投注 - 总赢分) - (总投注 × (1 - 目标RTP))

如果 水池盈余 <= 0:
    说明玩家赢得过多，水池不足
    → 降低RTP（减少20%）
否则:
    水池充足
    → 根据用户配置调整
```

**示例：**
```
假设：
- PoolBet = 10000（总投注）
- PoolWin = 9600（总赢分）
- gameRtp = 0.96（目标RTP 96%）

计算：
- 预期盈余 = 10000 × (1 - 0.96) = 400
- 实际盈余 = 10000 - 9600 = 400
- 水池盈余 = 400 - 400 = 0

结论：水池刚好平衡，需要降低RTP
```

### 3. 新手扶持模式（AdjustNormalNewbie）

**特点：** 根据用户投注次数和金额，为新手提供更高的RTP。

**CalculateRtpByAdjustNormalNewbie**
- **文件：** [module/jili-game-server/service/reqservice/spinservice/adjustrtp/adjust_normal_newbie.go](../../../module/jili-game-server/service/reqservice/spinservice/adjustrtp/adjust_normal_newbie.go)
- **参数定义：**

```go
const (
    cycleCount                    = 300    // 循环次数
    userPoolDeductRtp             = 0.05   // 个人池不足时扣除的RTP
    extremeBaseRtpUpperLimit      = 1.0    // 极端基础RTP上限
    noExperienceDeductRtp         = 0.015  // 非扶持期扣除的RTP
    firstExperienceBetTwdThreshold = 15    // 新手体验押注门槛(台币)
)

extremeBaseRtpLowerLimit = noExperienceDeductRtp + userPoolDeductRtp  // 极端基础RTP下限
```

**计算逻辑：**

```go
func CalculateRtpByAdjustNormalNewbie(request *entity.AdjustRequest) float64 {
    // 1. 计算当前用户RTP
    currentUserRtp := PoolWin / PoolBet
    
    // 2. 确定基础RTP
    baseRtp := MerchantRtp（如果启用） 或 CurrentRtp（默认）
    if UserRtpStatus 启用:
        baseRtp = UserRtp
    experienceRtp := max(baseRtp, 1.0) // 扶持RTP至少为1.0（100%）
    
    // 3. 极端情况不调控
    if baseRtp >= 1.0 或 baseRtp <= 0.065:
        return baseRtp
    
    // 4. 个人池校正
    if currentUserRtp >= baseRtp:
        baseRtp -= 0.05
    
    // 5. 新手且小额投注策略
    if TotalBetCount < 300 且 Cost <= firstExperienceBetThreshold:
        // 计算新手扶持次数
        newbieExperienceCount = floor(0.015 × 300 / (experienceRtp + 0.015 - baseRtp))
        
        if TotalBetCount < newbieExperienceCount:
            return experienceRtp // 新手扶持期，返回高RTP
        else:
            return baseRtp - 0.015 // 过了扶持期
    
    // 6. 老手或大额投注策略
    else:
        // 计算老手扶持次数（周期性扶持）
        oldExperienceCount = floor(0.015 × 300 / (experienceRtp + 0.015 - baseRtp))
        
        if (TotalBetCount % 300) < oldExperienceCount:
            return experienceRtp // 周期扶持期
        else:
            return baseRtp - 0.015 // 非扶持期
    }
}
```

**扶持次数计算公式推导：**

假设在一个周期（300次）内：
- 扶持期返还RTP为 `experienceRtp`
- 非扶持期返还RTP为 `baseRtp - 0.015`
- 总平均RTP为 `baseRtp`

则有：
```
r1 / 300 × experienceRtp + (300 - r1) / 300 × (baseRtp - 0.015) = baseRtp

解得：
r1 = 0.015 × 300 / (experienceRtp + 0.015 - baseRtp)
```

其中 `r1` 就是扶持次数。

**示例：**
```
假设：
- baseRtp = 0.96
- experienceRtp = 1.0
- cycleCount = 300

计算：
newbieExperienceCount = floor(0.015 × 300 / (1.0 + 0.015 - 0.96))
                      = floor(4.5 / 0.055)
                      = floor(81.8)
                      = 81

结论：新手在前81次小额投注中享受100% RTP扶持
```

### 内插法选择RTP表

**ChooseRtpTypeByInterpolation**
- **文件：** [module/jili-game-server/service/reqservice/spinservice/adjustrtp/interpolation.go](../../../module/jili-game-server/service/reqservice/spinservice/adjustrtp/interpolation.go)
- **功能：** 根据目标RTP，在配置的RTP表中使用内插法选择合适的表。

**算法逻辑：**

```go
func ChooseRtpTypeByInterpolation(rtpType2RtpMap map[string]float64, targetRtp float64) string {
    // 1. 查找目标RTP所在的区间
    rtpRangeKeys := findRtpRangeKeys(rtpType2RtpMap, targetRtp)
    
    // 2. 如果只有一个候选表，直接返回
    if len(rtpRangeKeys) == 1 {
        return rtpRangeKeys[0]
    }
    
    // 3. 计算内插概率
    lowerRtp := rtpType2RtpMap[rtpRangeKeys[0]]  // 下界RTP
    higherRtp := rtpType2RtpMap[rtpRangeKeys[1]] // 上界RTP
    
    p = (targetRtp - lowerRtp) / (higherRtp - lowerRtp)
    
    // 4. 随机选择
    bounded := 随机数 [0, 1)
    if bounded >= p:
        return rtpRangeKeys[0] // 返回下界表
    else:
        return rtpRangeKeys[1] // 返回上界表
}
```

**查找区间算法：**

```go
func findRtpRangeKeys(candidates map[string]float64, gameRtp float64) []string {
    // 遍历所有候选表
    for key, val := range candidates:
        // 1. 精准命中
        if val == gameRtp:
            return [key]
        
        // 2. 找比 gameRtp 小的最大值（下界）
        if val < gameRtp:
            if lowerKey == "" 或 val > lowerVal:
                lowerVal = val
                lowerKey = key
        
        // 3. 找比 gameRtp 大的最小值（上界）
        if val > gameRtp:
            if higherKey == "" 或 val < higherVal:
                higherVal = val
                higherKey = key
    
    // 4. 边界情况处理
    if lowerKey == "":
        return [minKey] // gameRtp 比所有表都小，返回最小表
    if higherKey == "":
        return [maxKey] // gameRtp 比所有表都大，返回最大表
    
    // 5. 正常情况，返回上下界
    return [lowerKey, higherKey]
}
```

**示例：**

```
假设配置：
rtpType2RtpMap = {
    "DYNAMIC_RTP_LOW": 0.94,
    "DYNAMIC_RTP_MIDDLE": 0.96,
    "DYNAMIC_RTP_HIGH": 0.98
}

目标RTP = 0.97

步骤：
1. 查找区间
   lowerKey = "DYNAMIC_RTP_MIDDLE", lowerVal = 0.96
   higherKey = "DYNAMIC_RTP_HIGH", higherVal = 0.98

2. 计算内插概率
   p = (0.97 - 0.96) / (0.98 - 0.96) = 0.01 / 0.02 = 0.5

3. 随机选择
   bounded = random() ∈ [0, 1)
   if bounded >= 0.5:
       return "DYNAMIC_RTP_MIDDLE" (概率50%)
   else:
       return "DYNAMIC_RTP_HIGH" (概率50%)

结果：
在长期运行中，50%选择MIDDLE表，50%选择HIGH表
平均RTP = 0.5 × 0.96 + 0.5 × 0.98 = 0.97 ✓
```

### 任务RTP扣除

**文件位置：** [module/jili-game-server/service/reqservice/spinservice/adjustrtp/mission.go](../../../module/jili-game-server/service/reqservice/spinservice/adjustrtp/mission.go)

系统会从目标RTP中扣除任务RTP，用于支持每日任务、VIP任务等。

```go
const (
    MissionDaily = "Mission_Daily"
    MissionVIP   = "Mission_VIP"
)

var MissionRtpMap = map[string]float64{
    MissionDaily: 0.01, // 每日任务占用1% RTP
    MissionVIP:   0.01, // VIP任务占用1% RTP
}

func CalculateMissionRtp() float64 {
    var totalRtp float64
    for _, rtp := range MissionRtpMap {
        totalRtp += rtp
    }
    return totalRtp // 总计2%
}
```

**应用：**
```go
// 在调控模式中
targetRtp := CalculateTargetRtpWithAdjustTypeAndMission(request)
totalMissionRtp := CalculateMissionRtp()
targetRtp = max(targetRtp - totalMissionRtp, 0.0)
```

---

## 权重计算方法详解

权重计算是调控系统的核心，它决定了最终开出的倍数和表演效果。

### 权重模式（WeightID）

**文件位置：** [module/jili-game-server/serverconst/game_adjust.go](../../../module/jili-game-server/serverconst/game_adjust.go)

```go
type WeightID int
const (
    WeightNone     WeightID = 1 // 原生权重开奖
    WeightSd1      WeightID = 2 // 校正标准差1
    WeightSd2      WeightID = 3 // 校正标准差2
    WeightSd3      WeightID = 4 // 校正标准差3
    WeightStreamer WeightID = 5 // 直播算法
    WeightFeature  WeightID = 6 // 特色算法
)
```

### 权重计算主函数

**CalculateWeightResult**
- **文件：** [module/jili-game-server/service/reqservice/spinservice/weightrtp/weight_flow.go](../../../module/jili-game-server/service/reqservice/spinservice/weightrtp/weight_flow.go)
- **逻辑：**

```go
func CalculateWeightResult(rtpType string, request *entity.AdjustRequest) (*entity.WeightResult, error) {
    switch serverconst.WeightID(request.MerchantAdjust.WeightID) {
    case serverconst.WeightNone:
        return CalculateWeightNoneResult(rtpType, request)
    case serverconst.WeightSd1:
        return CalculateWeightSd1Result(rtpType, request)
    case serverconst.WeightSd2:
        return CalculateWeightSd2Result(rtpType, request)
    case serverconst.WeightSd3:
        return CalculateWeightSd3Result(rtpType, request)
    case serverconst.WeightStreamer:
        return CalculateWeightStreamResult(rtpType, request)
    case serverconst.WeightFeature:
        return CalculateWeightFeatureResult(rtpType, request)
    default:
        return CalculateWeightSd3Result(rtpType, request)
    }
}
```

### 1. 原生权重（WeightNone）

**特点：** 不进行任何权重调整，直接使用配置的权重表。

**CalculateWeightNoneResult**
- **文件：** [module/jili-game-server/service/reqservice/spinservice/weightrtp/weight_none.go](../../../module/jili-game-server/service/reqservice/spinservice/weightrtp/weight_none.go)
- **实现：**

```go
func CalculateWeightNoneResult(rtpType string, request *entity.AdjustRequest) (*entity.WeightResult, error) {
    weightOddsList := request.AdjustConfig.PerformanceCtrConfig.RtpType2WeightOddsListMap[rtpType]
    weightPerformancesList := request.AdjustConfig.PerformanceCtrConfig.WeightPerformanceList
    
    return adjustcommon.CalculatePerformanceResultOrigin(weightOddsList, weightPerformancesList)
}
```

**CalculatePerformanceResultOrigin（核心开奖函数）**
- **文件：** [module/jili-game-server/service/reqservice/spinservice/adjustcommon/util.go](../../../module/jili-game-server/service/reqservice/spinservice/adjustcommon/util.go)
- **功能：** 根据权重随机选择倍数和表演索引。

```go
func CalculatePerformanceResultOrigin(
    weightOddsList []entity.WeightOddsPair,
    weightPerformancesList [][]entity.PerformanceWeightPair
) (*entity.WeightResult, error) {
    // 1. 根据权重选择倍数索引
    oddsWeightArray := CalculateOddsWeightArray(weightOddsList)
    oddsArrayIndex, err := CalculateWeightIndex(oddsWeightArray)
    
    // 2. 根据权重选择表演索引
    performanceResultWeightArray := make([]int, len(weightPerformancesList[oddsArrayIndex]))
    for i, performance := range weightPerformancesList[oddsArrayIndex] {
        performanceResultWeightArray[i] = performance.Weight
    }
    performanceResultArrayIndex, err := CalculateWeightIndex(performanceResultWeightArray)
    
    // 3. 返回结果
    return &entity.WeightResult{
        OddsArrayIndex:              oddsArrayIndex,
        PerformanceResultArrayIndex: performanceResultArrayIndex,
        Odds:                        weightOddsList[oddsArrayIndex].Odds,
        PerformanceIndex:            weightPerformancesList[oddsArrayIndex][performanceResultArrayIndex].PerformanceIndex,
    }, nil
}
```

**CalculateWeightIndex（权重随机算法）**
- **功能：** 根据权重列表随机选择一个索引。
- **算法：**

```go
func CalculateWeightIndex(weightList []int) (int, error) {
    // 1. 计算总权重
    totalWeight := sum(weightList)
    
    // 2. 生成随机值 [0, totalWeight)
    randomValue := random(totalWeight)
    
    // 3. 遍历权重列表，找到命中的索引
    for i, weight := range weightList {
        if randomValue < weight {
            return i
        }
        randomValue -= weight
    }
}
```

**示例：**

```
假设权重列表：[10, 30, 50, 10]
总权重 = 100

随机值 = 45

遍历过程：
i=0: 45 < 10? No, randomValue = 45 - 10 = 35
i=1: 35 < 30? No, randomValue = 35 - 30 = 5
i=2: 5 < 50? Yes, return i=2

结果：选中索引2

概率分布：
- 索引0: 10/100 = 10%
- 索引1: 30/100 = 30%
- 索引2: 50/100 = 50%
- 索引3: 10/100 = 10%
```

### 2. 标准差校正（WeightSd1/Sd2/Sd3）

**特点：** 限制标准差和最大倍数，降低游戏波动性。

#### 标准差校正算法原理

标准差（Standard Deviation, SD）衡量数据的离散程度。在游戏中：
- **高标准差** = 波动大，可能出现极高倍数或极低倍数
- **低标准差** = 波动小，倍数相对稳定

通过限制标准差，可以：
1. 减少极端情况（超高倍数）的出现
2. 保持RTP不变的情况下，让玩家体验更平稳

#### WeightSd1/Sd2/Sd3 区别

```go
// WeightSd1: 最严格，标准差限制为1.0
CalculateWeightSd1Result: maxSd = 1.0

// WeightSd2: 中等，标准差限制为2.0
CalculateWeightSd2Result: maxSd = 2.0

// WeightSd3: 最宽松，标准差限制为3.0
CalculateWeightSd3Result: maxSd = 3.0
```

#### calculatePerformanceResultOtherLimitMaxOddsAdjustSd

**文件位置：** [module/jili-game-server/service/reqservice/spinservice/weightrtp/weight_maxodds_adjustsd.go](../../../module/jili-game-server/service/reqservice/spinservice/weightrtp/weight_maxodds_adjustsd.go)

**功能：** 同时限制最大倍数和调整标准差。

```go
func calculatePerformanceResultOtherLimitMaxOddsAdjustSd(
    betAmount float64,
    maxSd float64,
    weightOddsList []entity.WeightOddsPair,
    weightPerformancesList [][]entity.PerformanceWeightPair,
    merchantAdjust *entity.MerchantAdjust,
) (*entity.WeightResult, error) {
    // 1. 限制最大倍数
    const userBetTwdAmountThreshold = 450.0 // 台币450元阈值
    const maxOddsThreshold = 50.0           // 最大50倍
    
    // 转换为台币金额
    userBetTwdAmount := ExchangeCurrency2TwdAmount(betAmount, merchantAdjust)
    
    // 如果投注金额 > 450台币，限制最大倍数为50倍
    weightOddsListDeducted, weightPerformancesListDeducted := 
        adjustWeightListByMaxOddsWithBetTwdAmount(
            weightOddsList,
            weightPerformancesList,
            userBetTwdAmount,
            userBetTwdAmountThreshold,
            maxOddsThreshold,
        )
    
    // 2. 调整标准差
    return calculatePerformanceResultAdjustSd(
        maxSd,
        weightOddsListDeducted,
        weightPerformancesListDeducted,
    )
}
```

#### adjustWeightListByMaxOddsWithBetTwdAmount

**文件位置：** [module/jili-game-server/service/reqservice/spinservice/weightrtp/weight_max_odds.go](../../../module/jili-game-server/service/reqservice/spinservice/weightrtp/weight_max_odds.go)

**功能：** 根据投注金额限制最大倍数。

```go
func adjustWeightListByMaxOddsWithBetTwdAmount(
    weightOddsListOrigin []entity.WeightOddsPair,
    weightPerformancesList [][]entity.PerformanceWeightPair,
    userBetTwdAmount float64,
    userBetTwdAmountThreshold float64,
    maxOddsThreshold float64,
) ([]entity.WeightOddsPair, [][]entity.PerformanceWeightPair) {
    // 小额投注不限制
    if userBetTwdAmount <= userBetTwdAmountThreshold {
        return weightOddsListOrigin, weightPerformancesList
    }
    
    // 大额投注限制最大倍数
    return adjustWeightListByMaxOddsWithMaxOddsThreshold(
        weightOddsListOrigin,
        weightPerformancesList,
        maxOddsThreshold,
    )
}
```

**示例：**
```
投注金额 = 500台币（> 450阈值）
→ 触发最大倍数限制
→ 所有 > 50倍的奖励被移除或降低权重

投注金额 = 300台币（< 450阈值）
→ 不限制最大倍数
→ 保持原始权重表
```

#### adjustWeightListByMaxOddsWithMaxOddsThreshold

**功能：** 限制最大倍数的核心算法。

```go
func adjustWeightListByMaxOddsWithMaxOddsThreshold(
    weightOddsListOrigin []entity.WeightOddsPair,
    weightPerformancesList [][]entity.PerformanceWeightPair,
    maxOddsThreshold float64,
) ([]entity.WeightOddsPair, [][]entity.PerformanceWeightPair) {
    // 1. 复制原始权重表
    weightOddsList := copy(weightOddsListOrigin)
    
    // 2. 计算总权重和统计量
    totalWeight := CalculateTotalWeight(weightOddsList)
    weightStatistic := CalculateStatistic(weightOddsList)
    
    // 3. 如果最大倍数 <= 阈值，无需调整
    if weightStatistic.MaxOdds <= maxOddsThreshold {
        return weightOddsList, weightPerformancesList
    }
    
    // 4. 计算候选倍数范围
    oddsLowerLimit := weightStatistic.AvgOdds
    oddsUpperLimit := maxOddsThreshold
    candidateOddsArray := calculateCandidateOddsArrayByOddsRange(
        weightOddsList,
        oddsLowerLimit,
        oddsUpperLimit,
        candidateOddsCount,
    )
    
    // 5. 无候选倍数，使用原算法
    if len(candidateOddsArray) == 0 {
        return CalculatePerformanceResultOrigin(weightOddsList, weightPerformancesList)
    }
    
    // 6. 消减超过阈值的倍数
    totalWeightAfterDeducted, totalRtpAfterDeducted, deductedRtp := 
        deductMaxOdds(totalWeight, weightOddsList, weightStatistic.AvgOdds, maxOddsThreshold)
    
    // 7. 将消减的RTP重新分配给候选倍数
    distributeRtp2CandidateOdds(
        candidateOddsArray,
        weightOddsList,
        totalWeightAfterDeducted,
        totalRtpAfterDeducted,
        deductedRtp,
    )
    
    // 8. 返回调整后的权重表
    return weightOddsList, weightPerformancesList
}
```

**算法步骤详解：**

1. **计算候选倍数**
   - 选择介于平均倍数和最大倍数阈值之间的倍数
   - 这些倍数将接收被消减的RTP

2. **消减超过阈值的倍数**
   - 将所有 > maxOddsThreshold 的倍数权重设为0
   - 计算被消减的RTP总量

3. **重新分配RTP**
   - 将消减的RTP按比例分配给候选倍数
   - 增加候选倍数的权重

#### deductMaxOdds（消减最大倍数）

**文件位置：** [module/jili-game-server/service/reqservice/spinservice/weightrtp/weight_max_odds.go](../../../module/jili-game-server/service/reqservice/spinservice/weightrtp/weight_max_odds.go)

```go
func deductMaxOdds(
    totalWeight int,
    weightOddsList []entity.WeightOddsPair,
    totalRtp float64,
    maxOdds float64,
) (int, float64, float64) {
    deductedRtp := 0.0
    deductedWeight := 0
    totalWeightAfterDeducted := totalWeight
    
    // 从后往前遍历（倍数从大到小）
    for i := len(weightOddsList) - 1; i >= 0; i-- {
        weightOdds := weightOddsList[i]
        
        // 如果倍数 <= 最大倍数阈值，停止
        if weightOdds.Odds <= maxOdds {
            break
        }
        
        // 计算该倍数的RTP贡献
        prob := float64(weightOdds.Weight) / float64(totalWeight)
        rtp := weightOdds.Odds * prob
        
        // 累加被消减的RTP和权重
        deductedRtp += rtp
        deductedWeight += weightOdds.Weight
        totalWeightAfterDeducted -= weightOdds.Weight
        
        // 将权重设为0
        weightOddsList[i].Weight = 0
    }
    
    // 校正RTP（保持总RTP不变）
    totalRtpAfterDeductedAndScale := totalRtp - deductedRtp
    deductedRtpAfterScale := deductedRtp
    
    if totalWeightAfterDeducted > 0 {
        scale := totalRtp / totalRtpAfterDeductedAndScale
        totalRtpAfterDeductedAndScale *= scale
        deductedRtpAfterScale = totalRtp - totalRtpAfterDeductedAndScale
    }
    
    return totalWeightAfterDeducted, totalRtpAfterDeductedAndScale, deductedRtpAfterScale
}
```

**示例：**

```
原始权重表：
索引  倍数   权重   概率   RTP贡献
0    0     100   10%    0
1    1     200   20%    0.2
2    5     300   30%    1.5
3    10    200   20%    2.0
4    50    100   10%    5.0
5    100   100   10%    10.0
总计        1000  100%   18.7

限制最大倍数 = 50

消减过程：
i=5: odds=100 > 50, 消减
  - deductedRtp += 10.0
  - weight[5] = 0
  
i=4: odds=50 <= 50, 停止

消减后：
索引  倍数   权重   概率      RTP贡献
0    0     100   11.11%    0
1    1     200   22.22%    0.222
2    5     300   33.33%    1.667
3    10    200   22.22%    2.222
4    50    100   11.11%    5.556
5    100   0     0%        0
总计        900   100%      9.667

需要重新分配的RTP = 18.7 - 9.667 = 9.033
```

#### distributeRtp2CandidateOdds（分配RTP给候选倍数）

```go
func distributeRtp2CandidateOdds(
    candidatesOddsList []int,
    weightOddsList []entity.WeightOddsPair,
    totalWeightAfterDeducted int,
    totalRtpAfterDeductedAndScale float64,
    deductedRtpAfterScale float64,
) {
    // 候选倍数按从小到大排序
    sort(candidatesOddsList)
    
    // 遍历候选倍数，逐步分配RTP
    lastAdjustRtp := totalRtpAfterDeductedAndScale
    
    for _, candidateIndex := range candidatesOddsList {
        candidateOdds := weightOddsList[candidateIndex].Odds
        
        // 计算当前目标RTP
        currentAdjustRtp := totalRtpAfterDeductedAndScale + deductedRtpAfterScale
        
        // 如果已经分配完，退出
        if currentAdjustRtp >= totalRtpAfterDeductedAndScale + deductedRtpAfterScale {
            break
        }
        
        // 计算需要增加的权重
        additionalWeight := 0
        if (candidateOdds - currentAdjustRtp) > 0 {
            additionalWeight = int((currentAdjustRtp - lastAdjustRtp) * float64(totalWeightAfterDeducted) / (candidateOdds - currentAdjustRtp))
        }
        
        // 增加权重
        weightOddsList[candidateIndex].Weight += additionalWeight
        totalWeightAfterDeducted += additionalWeight
        
        lastAdjustRtp = currentAdjustRtp
    }
}
```

#### calculatePerformanceResultAdjustSd（调整标准差）

**文件位置：** [module/jili-game-server/service/reqservice/spinservice/weightrtp/weight_adjust_sd.go](../../../module/jili-game-server/service/reqservice/spinservice/weightrtp/weight_adjust_sd.go)

**功能：** 通过调整权重表降低标准差。

```go
func calculatePerformanceResultAdjustSd(
    maxSd float64,
    weightOddsListOrigin []entity.WeightOddsPair,
    weightPerformancesList [][]entity.PerformanceWeightPair,
) (*entity.WeightResult, error) {
    // 1. 复制权重表
    weightOddsList := copy(weightOddsListOrigin)
    
    // 2. 计算总权重
    totalWeight := CalculateTotalWeight(weightOddsList)
    
    // 3. 计算统计量
    weightStatistic := CalculateStatistic(weightOddsList)
    
    // 4. 计算超出的方差
    extraVariance := weightStatistic.Variance - (maxSd * maxSd)
    
    // 5. 如果方差足够小，使用原算法
    if extraVariance <= 0.0 {
        return CalculatePerformanceResultOrigin(weightOddsList, weightPerformancesList)
    }
    
    // 6. 计算候选添加权重倍数
    candidateOddsArray := calculateCandidateOddsArrayBySd(
        weightOddsList,
        weightStatistic.AvgOdds,
        maxSd,
        candidateOddsCount,
    )
    
    // 7. 无候选倍数，使用原算法
    if len(candidateOddsArray) == 0 {
        return CalculatePerformanceResultOrigin(weightOddsList, weightPerformancesList)
    }
    
    // 8. 消减方差（通过消减高倍数）
    totalWeightAfterDeducted, totalRtpAfterDeducted, deductedRtp := 
        deductVariance(
            totalWeight,
            weightOddsList,
            weightStatistic.AvgOdds,
            maxSd,
            extraVariance,
        )
    
    // 9. 重新分配RTP给候选倍数
    distributeRtp2CandidateOdds(
        candidateOddsArray,
        weightOddsList,
        totalWeightAfterDeducted,
        totalRtpAfterDeducted,
        deductedRtp,
    )
    
    // 10. 计算结果
    return CalculatePerformanceResultOrigin(weightOddsList, weightPerformancesList)
}
```

**CalculateStatistic（计算统计量）**

**文件位置：** [module/jili-game-server/service/reqservice/spinservice/adjustcommon/util.go](../../../module/jili-game-server/service/reqservice/spinservice/adjustcommon/util.go)

```go
func CalculateStatistic(weightOddsList []entity.WeightOddsPair) *entity.WeightStatistic {
    avgOdds := 0.0
    maxOdds := weightOddsList[0].Odds
    totalOdds2 := 0.0
    totalWeight := CalculateTotalWeight(weightOddsList)
    
    for _, weightOdds := range weightOddsList {
        prob := float64(weightOdds.Weight) / float64(totalWeight)
        rtp := weightOdds.Odds * prob           // 期望值的一部分
        odds2 := (weightOdds.Odds * weightOdds.Odds) * prob  // 二阶矩的一部分
        
        avgOdds += rtp
        totalOdds2 += odds2
        
        if weightOdds.Odds > maxOdds {
            maxOdds = weightOdds.Odds
        }
    }
    
    variance := totalOdds2 - (avgOdds * avgOdds)  // Var(X) = E[X²] - E[X]²
    stdDev := sqrt(variance)
    
    return &entity.WeightStatistic{
        AvgOdds:  avgOdds,
        MaxOdds:  maxOdds,
        Variance: variance,
        StdDev:   stdDev,
    }
}
```

**统计学公式：**

```
平均倍数（期望值）：
E[X] = Σ(xi × pi)

二阶矩：
E[X²] = Σ(xi² × pi)

方差：
Var(X) = E[X²] - E[X]²

标准差：
SD(X) = √Var(X)
```

**deductVariance（消减方差）**

```go
func deductVariance(
    totalWeight int,
    weightOddsList []entity.WeightOddsPair,
    totalRtp float64,
    targetSd float64,
    extraVariance float64,
) (int, float64, float64) {
    deductedRtp := 0.0
    deductedOdds2 := 0.0
    deductedWeight := 0
    accumulatedVarianceReduction := 0.0
    totalWeightAfterDeducted := totalWeight
    
    // 从后往前遍历（倍数从大到小）
    for i := len(weightOddsList) - 1; i >= 0; i-- {
        weightOdds := weightOddsList[i]
        
        // 如果倍数与平均值的距离 <= 目标标准差，停止
        if weightOdds.Odds - totalRtp <= targetSd {
            break
        }
        
        // 计算该倍数对方差的贡献
        prob := float64(weightOdds.Weight) / float64(totalWeight)
        rtp := weightOdds.Odds * prob
        odds2 := (weightOdds.Odds * weightOdds.Odds) * prob
        
        // 方差减少量 = odds² 项的减少
        varianceReduction := odds2
        
        // 累加
        accumulatedVarianceReduction += varianceReduction
        deductedRtp += rtp
        deductedOdds2 += odds2
        deductedWeight += weightOdds.Weight
        totalWeightAfterDeducted -= weightOdds.Weight
        
        // 将权重设为0
        weightOddsList[i].Weight = 0
        
        // 如果已经消减了足够的方差，停止
        if accumulatedVarianceReduction >= extraVariance {
            break
        }
    }
    
    // 校正RTP
    totalRtpAfterDeductedAndScale := totalRtp - deductedRtp
    deductedRtpAfterScale := deductedRtp
    
    if totalWeightAfterDeducted > 0 {
        scale := totalRtp / totalRtpAfterDeductedAndScale
        totalRtpAfterDeductedAndScale *= scale
        deductedRtpAfterScale = totalRtp - totalRtpAfterDeductedAndScale
    }
    
    return totalWeightAfterDeducted, totalRtpAfterDeductedAndScale, deductedRtpAfterScale
}
```

**示例：**

```
原始权重表：
倍数   权重   概率   E[X]   E[X²]
0     100   10%    0      0
1     200   20%    0.2    0.2
5     300   30%    1.5    7.5
10    200   20%    2.0    20.0
50    100   10%    5.0    250.0
100   100   10%    10.0   1000.0

平均倍数 E[X] = 18.7
E[X²] = 1277.7
方差 Var(X) = 1277.7 - 18.7² = 927.81
标准差 SD(X) = √927.81 = 30.46

目标标准差 = 3.0
超出方差 = 927.81 - 9 = 918.81

消减过程：
i=5: odds=100, odds-E[X]=81.3 > 3.0, 消减
  - varianceReduction = 1000.0
  - accumulatedVarianceReduction = 1000.0
  - accumulatedVarianceReduction > 918.81, 停止

消减后：
倍数   权重   概率   E[X]   E[X²]
0     100   11.11% 0      0
1     200   22.22% 0.222  0.222
5     300   33.33% 1.667  8.335
10    200   22.22% 2.222  22.22
50    100   11.11% 5.556  277.8
100   0     0%     0      0

平均倍数 E[X] = 9.667
E[X²] = 308.577
方差 Var(X) = 308.577 - 9.667² = 215.15
标准差 SD(X) = √215.15 = 14.67

仍大于3.0，继续消减...
（实际算法会递归消减直到满足条件或无法继续）
```

### 3. 直播算法（WeightStreamer）

**特点：** 专为直播设计，确保特色表演的出现。

**CalculateWeightStreamResult**
- **文件位置：** [module/jili-game-server/service/reqservice/spinservice/weightrtp/weight_stream.go](../../../module/jili-game-server/service/reqservice/spinservice/weightrtp/weight_stream.go)
- **逻辑：**

```go
func CalculateWeightStreamResult(rtpType string, request *entity.AdjustRequest) (*entity.WeightResult, error) {
    // 1. 获取权重表
    weightOddsList := request.AdjustConfig.PerformanceCtrConfig.RtpType2WeightOddsListMap[rtpType]
    weightPerformancesList := request.AdjustConfig.PerformanceCtrConfig.WeightPerformanceList
    
    // 2. 获取特色倍数
    featureOdds := GetFeatureOdds(request.GameCode)
    
    // 3. 如果用户需要强制特色
    if request.UserAdjust.UserAdjustControl.ForceFeature {
        return calculatePerformanceResultAbsoluteFeature(weightOddsList, weightPerformancesList)
    }
    
    // 4. 一般开奖
    return adjustcommon.CalculatePerformanceResultOrigin(weightOddsList, weightPerformancesList)
}
```

**calculatePerformanceResultAbsoluteFeature（强制特色）**

```go
func calculatePerformanceResultAbsoluteFeature(
    weightOddsList []entity.WeightOddsPair,
    weightPerformancesList [][]entity.PerformanceWeightPair,
) (*entity.WeightResult, error) {
    // 1. 获取特色倍数
    featureOdds := GetFeatureOdds()
    
    // 2. 分类倍数
    zeroOddsIndexList, nonFeatureOddsIndexList, featureOddsIndexList := 
        getOddsIndexListByFeatureOddsAndTopN(weightOddsList, featureOdds)
    
    // 3. 如果没有特色倍数，使用原算法
    if len(featureOddsIndexList) == 0 {
        return adjustcommon.CalculatePerformanceResultOrigin(weightOddsList, weightPerformancesList)
    }
    
    // 4. 校正倍数权重表
    adjustWeightOddsListByFeatureOddsList(
        weightOddsList,
        zeroOddsIndexList,
        nonFeatureOddsIndexList,
        featureOddsIndexList,
        ZeroTotalWeight,
        NonFeatureExceptZeroTotalWeight,
        FeatureTotalWeight,
    )
    
    // 5. 计算结果
    return adjustcommon.CalculatePerformanceResultOrigin(weightOddsList, weightPerformancesList)
}
```

**adjustWeightOddsListByFeatureOddsList（调整权重以强制特色）**

```go
func adjustWeightOddsListByFeatureOddsList(
    weightedOddsList []entity.WeightOddsPair,
    zeroOddsIndexList []int,
    nonFeatureOddsIndexList []int,
    featureOddsIndexList []int,
    zeroTotalWeight int,
    nonFeatureExceptZeroTotalWeight int,
    featureTotalWeight int,
) {
    // 1. 计算每个倍数应该分配的权重
    var nonFeatureExceptZeroTotalWeightPerOdds = 0
    if len(nonFeatureOddsIndexList) > 0 {
        nonFeatureExceptZeroTotalWeightPerOdds = int(ceil(float64(nonFeatureExceptZeroTotalWeight / len(nonFeatureOddsIndexList))))
    }
    
    var featureTotalWeightPerOdds = 0
    if len(featureOddsIndexList) > 0 {
        featureTotalWeightPerOdds = int(ceil(float64(featureTotalWeight / len(featureOddsIndexList))))
    }
    
    // 2. 重新分配权重
    for _, oddsIndex := range zeroOddsIndexList {
        weightedOddsList[oddsIndex].Weight = zeroTotalWeight
    }
    for _, oddsIndex := range nonFeatureOddsIndexList {
        weightedOddsList[oddsIndex].Weight = nonFeatureExceptZeroTotalWeightPerOdds
    }
    for _, oddsIndex := range featureOddsIndexList {
        weightedOddsList[oddsIndex].Weight = featureTotalWeightPerOdds
    }
}
```

**权重分配策略：**

```
假设配置：
- ZeroTotalWeight = 100（0倍总权重）
- NonFeatureExceptZeroTotalWeight = 400（非特色倍数总权重）
- FeatureTotalWeight = 500（特色倍数总权重）

倍数列表：
索引  倍数   类型
0    0     零倍
1    1     非特色
2    3     非特色
3    5     特色
4    10    特色
5    50    特色

权重调整：
- weightedOddsList[0].Weight = 100
- weightedOddsList[1].Weight = 200 (400/2)
- weightedOddsList[2].Weight = 200 (400/2)
- weightedOddsList[3].Weight = 167 (500/3)
- weightedOddsList[4].Weight = 167 (500/3)
- weightedOddsList[5].Weight = 166 (500/3)

总权重 = 100 + 200 + 200 + 167 + 167 + 166 = 1000

特色概率 = (167 + 167 + 166) / 1000 = 50%
```

### 4. 特色算法（WeightFeature）

**特点：** 按顺序表演特定的特色内容。

**CalculateWeightFeatureResult**
- **文件位置：** [module/jili-game-server/service/reqservice/spinservice/weightrtp/weight_feature.go](../../../module/jili-game-server/service/reqservice/spinservice/weightrtp/weight_feature.go)
- **逻辑：**

```go
func CalculateWeightFeatureResult(rtpType string, request *entity.AdjustRequest) (*entity.WeightResult, error) {
    // 1. 获取特色列表
    featureList := GetFeatureList(request.GameCode)
    
    // 2. 计算此次应该表演的特色索引
    targetFeatureIndex := calculateTargetFeatureIndex(featureList, request.UserAdjust.UserAdjustControl)
    
    // 3. 根据特色索引计算权重结果
    return calculateWeightResult(rtpType, request.AdjustConfig, targetFeatureIndex)
}
```

**calculateTargetFeatureIndex（计算目标特色索引）**

```go
func calculateTargetFeatureIndex(
    featureList []int,
    userAdjustControl *model.AdjustUserControlModel,
) int {
    if featureList == nil {
        return 0
    }
    
    // 根据当前投注次数循环选择特色
    targetIndex := int(userAdjustControl.CurrentBetCount) % len(featureList)
    
    return featureList[targetIndex]
}
```

**示例：**

```
特色列表 = [10, 20, 15, 25]（表演索引）

用户投注次数：
CurrentBetCount = 0 → targetIndex = 0 % 4 = 0 → 表演10
CurrentBetCount = 1 → targetIndex = 1 % 4 = 1 → 表演20
CurrentBetCount = 2 → targetIndex = 2 % 4 = 2 → 表演15
CurrentBetCount = 3 → targetIndex = 3 % 4 = 3 → 表演25
CurrentBetCount = 4 → targetIndex = 4 % 4 = 0 → 表演10（循环）
...
```

**calculateWeightResult（根据表演索引计算结果）**

```go
func calculateWeightResult(
    rtpType string,
    adjustConfig *entity.AdjustConfig,
    performanceIndex int,
) (*entity.WeightResult, error) {
    result := &entity.WeightResult{}
    
    findFlag := false
    weightOddsList := adjustConfig.PerformanceCtrConfig.RtpType2WeightOddsListMap[rtpType]
    
    // 遍历查找指定的表演索引
    for oddsArrayIndex, performanceWeightPairList := range adjustConfig.PerformanceCtrConfig.WeightPerformanceList {
        for performanceArrayIndex, performanceWeightPair := range performanceWeightPairList {
            if performanceWeightPair.PerformanceIndex == performanceIndex {
                result.PerformanceResultArrayIndex = performanceArrayIndex
                result.OddsArrayIndex = oddsArrayIndex
                result.PerformanceIndex = performanceIndex
                findFlag = true
                break
            }
        }
    }
    
    if !findFlag {
        return nil, errors.New("performance index not found")
    }
    
    result.Odds = weightOddsList[result.OddsArrayIndex].Odds
    
    return result, nil
}
```

---


## 游戏结果生成与缩放

在权重计算完成后，系统需要根据PerformanceIndex获取游戏结果模板，并根据实际投注金额进行缩放。

### getTemplateBoardResultAndScale（获取并缩放游戏结果）

**文件位置：** [module/jili-game-server/service/reqservice/spinservice/spin.go](../../../module/jili-game-server/service/reqservice/spinservice/spin.go)

**功能：** 根据投注模式和表演索引获取游戏结果模板，并根据实际投注金额进行缩放。

```go
func getTemplateBoardResultAndScale(
    spinCost float64,
    gameBetMode serverconst.GameBetMode,
    adjustResult *entity.AdjustResult,
) (string, error) {
    // 1. 根据投注模式选择表名
    tableName := ""
    switch gameBetMode {
    case serverconst.CardBet:
        tableName = model.BoardResultCard_TableName
    case serverconst.BuyFeatureBet01:
        tableName = model.BoardResultBuy_TableName
    case serverconst.ExtraBet01:
        tableName = model.BoardResultExtra1_TableName
    case serverconst.ExtraBet02:
        tableName = model.BoardResultExtra2_TableName
    case serverconst.NormalBet:
        tableName = model.BoardResultNormal_TableName
    default:
    }
    
    // 2. 从ES获取游戏结果模板
    templateResult, err := reqdataservice.GetGameResult(
        tableName,
        adjustResult.GameCode,
        adjustResult.WeightResult.PerformanceIndex,
    )
    if err != nil {
        return "", err
    }
    
    // 3. 缩放游戏结果
    return scaleTargetBoardResult(templateResult, spinCost, adjustResult.GameCode)
}
```

#### 步骤详解

**步骤1：选择结果表**

根据投注模式选择不同的Elasticsearch表：

| 投注模式 | 表名 | 说明 |
|---------|------|------|
| NormalBet | BoardResultNormal | 普通投注结果表 |
| CardBet | BoardResultCard | 卡片投注结果表 |
| BuyFeatureBet01 | BoardResultBuy | 购买特色结果表 |
| ExtraBet01 | BoardResultExtra1 | 额外投注1结果表 |
| ExtraBet02 | BoardResultExtra2 | 额外投注2结果表 |

**步骤2：获取游戏结果模板**

**GetGameResult**
- **文件：** [module/jili-game-server/dataservice/reqdataservice/spin.go](../../../module/jili-game-server/dataservice/reqdataservice/spin.go)
- **功能：** 从Elasticsearch中查询游戏结果模板

```go
func GetGameResult(
    tableName string,      // 表名
    gameCode string,       // 游戏代码
    performanceIdx int,    // 表演索引
) ([]interface{}, error) {
    return reqrepository.GetESGameResult(tableName, gameCode, performanceIdx)
}
```

**查询逻辑：**
```
ES查询条件：
- 表名：BoardResultNormal（或其他表）
- gameCode：游戏代码（如 "109"）
- performanceIndex：表演索引（如 5）

返回：
- 游戏结果模板（JSON数组）
  包含：盘面信息、赢分、特效等
```

**游戏结果模板示例：**
```json
[
  {
    "request": {
      "bet": 1.0,
      "gameCode": "109"
    },
    "response": {
      "totalWin": 5.0,
      "roundIndex": 12345,
      "data": {
        "board": [1, 2, 3, 4, 5],
        "winLines": [
          {"line": 1, "symbols": [1, 1, 1], "win": 3.0},
          {"line": 2, "symbols": [2, 2, 2], "win": 2.0}
        ]
      }
    }
  }
]
```

**步骤3：缩放游戏结果**

### scaleTargetBoardResult（缩放游戏结果）

**文件位置：** [module/jili-game-server/service/reqservice/spinservice/spin.go](../../../module/jili-game-server/service/reqservice/spinservice/spin.go)

**功能：** 根据实际投注金额缩放游戏结果中的所有金额字段。

```go
func scaleTargetBoardResult(
    templateBoardResult []interface{},  // 模板结果
    spinCost float64,                   // 实际投注金额
    gameCode string,                    // 游戏代码
) (string, error) {
    // 1. 转换为JSON格式
    jsonBytes, err := json.Marshal(templateBoardResult)
    if err != nil {
        return "", err
    }
    data := string(jsonBytes)
    
    // 2. 获取需要缩放的路径列表
    uniqueScalePathList, _ := app.Context.ScalePathManager.GetGameScalePaths(gameCode)
    
    // 3. 计算缩放因子
    templateBet := gjson.Get(data, serverconst.ScaleRequestBetPath).Float()
    scaleFactor := CalculateScaleFactor(templateBet, spinCost)
    
    // 4. 更新投注金额
    newData, err := sjson.Set(data, serverconst.ScaleRequestBetPath, spinCost)
    if err != nil {
        return "", err
    }
    
    // 5. 缩放所有金额路径
    platesJson, err := util.ScaleExistingPaths(newData, uniqueScalePathList, scaleFactor)
    if err != nil {
        return "", err
    }
    
    // 6. 返回结果
    return platesJson, nil
}
```

#### 缩放算法详解

**计算缩放因子**

```go
func CalculateScaleFactor(templateBet float64, actualBet float64) float64 {
    if templateBet == 0 {
        return 1.0
    }
    return actualBet / templateBet
}
```

**公式：**
```
scaleFactor = actualBet / templateBet

例如：
- 模板投注额：1.0
- 实际投注额：10.0
- 缩放因子：10.0 / 1.0 = 10.0

所有奖励金额都会乘以10.0
```

**缩放路径管理**

`ScalePathManager` 管理每个游戏需要缩放的JSON路径：

**常用路径：**
```go
const (
    ScaleRequestBetPath  = "0.request.bet"        // 投注金额路径
    ScaleResponseWinPath = "0.response.totalWin"  // 总赢分路径
    ScaleResponseDataPath = "0.response.data"     // 数据路径
)
```

**游戏特定路径示例：**
```
游戏109（Fortune Gems）的缩放路径：
- "0.response.totalWin"                    // 总赢分
- "0.response.data.winLines[*].win"        // 每条赢线的奖金
- "0.response.data.scatterWin"             // 散布奖金
- "0.response.data.freeSpins.totalWin"     // 免费旋转总赢分
```

**ScaleExistingPaths（缩放所有路径）**

```go
func ScaleExistingPaths(
    data string,              // JSON数据
    paths []string,           // 需要缩放的路径列表
    scaleFactor float64,      // 缩放因子
) (string, error) {
    result := data
    
    for _, path := range paths {
        // 1. 获取原始值
        originalValue := gjson.Get(result, path)
        
        if !originalValue.Exists() {
            continue // 路径不存在，跳过
        }
        
        // 2. 根据类型缩放
        var newValue interface{}
        switch originalValue.Type {
        case gjson.Number:
            // 数值类型：直接乘以缩放因子
            newValue = originalValue.Float() * scaleFactor
            
        case gjson.JSON:
            // 数组类型：递归缩放每个元素
            if originalValue.IsArray() {
                scaledArray := []float64{}
                for _, item := range originalValue.Array() {
                    scaledArray = append(scaledArray, item.Float() * scaleFactor)
                }
                newValue = scaledArray
            }
        }
        
        // 3. 更新值
        result, err = sjson.Set(result, path, newValue)
        if err != nil {
            return "", err
        }
    }
    
    return result, nil
}
```

#### 完整缩放示例

**原始模板（投注额1.0）：**
```json
[
  {
    "request": {
      "bet": 1.0,
      "gameCode": "109"
    },
    "response": {
      "totalWin": 5.0,
      "roundIndex": 12345,
      "data": {
        "board": [1, 2, 3, 4, 5],
        "winLines": [
          {"line": 1, "symbols": [1, 1, 1], "win": 3.0},
          {"line": 2, "symbols": [2, 2, 2], "win": 2.0}
        ],
        "scatterWin": 0,
        "freeSpins": null
      }
    }
  }
]
```

**实际投注额：10.0**

**缩放过程：**

```
1. 计算缩放因子
   scaleFactor = 10.0 / 1.0 = 10.0

2. 更新投注金额
   "0.request.bet" = 10.0

3. 缩放路径列表：
   - "0.response.totalWin"
   - "0.response.data.winLines[0].win"
   - "0.response.data.winLines[1].win"
   - "0.response.data.scatterWin"

4. 缩放每个路径：
   "0.response.totalWin":
     原始值 = 5.0
     新值 = 5.0 × 10.0 = 50.0
   
   "0.response.data.winLines[0].win":
     原始值 = 3.0
     新值 = 3.0 × 10.0 = 30.0
   
   "0.response.data.winLines[1].win":
     原始值 = 2.0
     新值 = 2.0 × 10.0 = 20.0
   
   "0.response.data.scatterWin":
     原始值 = 0
     新值 = 0 × 10.0 = 0
```

**缩放后结果（投注额10.0）：**
```json
[
  {
    "request": {
      "bet": 10.0,
      "gameCode": "109"
    },
    "response": {
      "totalWin": 50.0,
      "roundIndex": 12345,
      "data": {
        "board": [1, 2, 3, 4, 5],
        "winLines": [
          {"line": 1, "symbols": [1, 1, 1], "win": 30.0},
          {"line": 2, "symbols": [2, 2, 2], "win": 20.0}
        ],
        "scatterWin": 0,
        "freeSpins": null
      }
    }
  }
]
```

**验证：**
```
倍数验证：
- 原始倍数 = totalWin / bet = 5.0 / 1.0 = 5倍
- 缩放后倍数 = totalWin / bet = 50.0 / 10.0 = 5倍 ✓

倍数保持不变，金额按比例缩放 ✓
```

#### 特殊情况处理

**1. 数组路径缩放**

对于数组路径（如 `winLines[*].win`），系统会自动遍历所有元素：

```go
// 通配符路径
path = "0.response.data.winLines[*].win"

// 实际缩放时会展开为：
paths = [
    "0.response.data.winLines[0].win",
    "0.response.data.winLines[1].win",
    "0.response.data.winLines[2].win",
    // ...
]
```

**2. 嵌套结构缩放**

对于嵌套的JSON结构：

```json
{
  "freeSpins": {
    "totalWin": 100.0,
    "spins": [
      {"win": 20.0},
      {"win": 30.0},
      {"win": 50.0}
    ]
  }
}
```
---

## 核心函数与文件索引

### 核心入口函数

| 函数名 | 文件位置 | 功能描述 |
|--------|----------|----------|
| `DoSpin` | [spin.go](../../../module/jili-game-server/service/reqservice/spinservice/spin.go) | 游戏旋转主入口 |
| `CalculateGameModeCategoryAndGameBetMode` | [gamemodecalculator.go](../../../module/jili-game-server/service/reqservice/spinservice/gamemodecalculator.go) | 计算游戏模式和投注模式 |
| `CalculateSpinCost` | [gamemodecalculator.go](../../../module/jili-game-server/service/reqservice/spinservice/gamemodecalculator.go) | 计算投注成本 |
| `CalculateAdjustRequest` | [adjustmodule.go](../../../module/jili-game-server/service/reqservice/spinservice/adjustmodule.go) | 构建调整请求 |
| `StartAdjust` | [adjustmodule.go](../../../module/jili-game-server/service/reqservice/spinservice/adjustmodule.go) | 开始调整处理 |
| `getTemplateBoardResultAndScale` | [spin.go](../../../module/jili-game-server/service/reqservice/spinservice/spin.go) | 获取并缩放游戏结果 |
| `scaleTargetBoardResult` | [spin.go](../../../module/jili-game-server/service/reqservice/spinservice/spin.go) | 缩放游戏结果金额 |
| `GetGameResult` | [reqdataservice/spin.go](../../../module/jili-game-server/dataservice/reqdataservice/spin.go) | 从ES获取游戏结果模板 |

### RTP计算函数

| 函数名 | 文件位置 | 功能描述 |
|--------|----------|----------|
| `CalculateRtpType` | [adjustmodule.go](../../../module/jili-game-server/service/reqservice/spinservice/adjustmodule.go) | 计算RTP类型 |
| `ChoseRtpTypeWithCard` | [adjust_flow.go](../../../module/jili-game-server/service/reqservice/spinservice/adjustrtp/adjust_flow.go) | 卡片模式RTP选择 |
| `ChoseRtpTypeRandom` | [adjust_flow.go](../../../module/jili-game-server/service/reqservice/spinservice/adjustrtp/adjust_flow.go) | 自然不控RTP选择 |
| `ChoseRtpTypeWithAdjustTypeAndMission` | [adjust_flow.go](../../../module/jili-game-server/service/reqservice/spinservice/adjustrtp/adjust_flow.go) | 调控模式RTP选择 |
| `CalculateRtpByAdjustNormalFix` | [adjust_normal_fix.go](../../../module/jili-game-server/service/reqservice/spinservice/adjustrtp/adjust_normal_fix.go) | 自然不控RTP计算 |
| `CalculateRtpByAdjustNormalMerchantDynamic` | [adjust_normal_merchant_dynamic.go](../../../module/jili-game-server/service/reqservice/spinservice/adjustrtp/adjust_normal_merchant_dynamic.go) | 基本水池RTP计算 |
| `CalculateRtpByAdjustNormalNewbie` | [adjust_normal_newbie.go](../../../module/jili-game-server/service/reqservice/spinservice/adjustrtp/adjust_normal_newbie.go) | 新手扶持RTP计算 |
| `ChooseRtpTypeByInterpolation` | [interpolation.go](../../../module/jili-game-server/service/reqservice/spinservice/adjustrtp/interpolation.go) | 内插法选择RTP表 |

### 权重计算函数

| 函数名 | 文件位置 | 功能描述 |
|--------|----------|----------|
| `CalculateWeightResult` | [weight_flow.go](../../../module/jili-game-server/service/reqservice/spinservice/weightrtp/weight_flow.go) | 权重计算主入口 |
| `CalculateWeightNoneResult` | [weight_none.go](../../../module/jili-game-server/service/reqservice/spinservice/weightrtp/weight_none.go) | 原生权重计算 |
| `CalculateWeightSd1Result` | [weight_sd1.go](../../../module/jili-game-server/service/reqservice/spinservice/weightrtp/weight_sd1.go) | 标准差1权重计算 |
| `CalculateWeightSd2Result` | [weight_sd2.go](../../../module/jili-game-server/service/reqservice/spinservice/weightrtp/weight_sd2.go) | 标准差2权重计算 |
| `CalculateWeightSd3Result` | [weight_sd3.go](../../../module/jili-game-server/service/reqservice/spinservice/weightrtp/weight_sd3.go) | 标准差3权重计算 |
| `CalculateWeightStreamResult` | [weight_stream.go](../../../module/jili-game-server/service/reqservice/spinservice/weightrtp/weight_stream.go) | 直播权重计算 |
| `CalculateWeightFeatureResult` | [weight_feature.go](../../../module/jili-game-server/service/reqservice/spinservice/weightrtp/weight_feature.go) | 特色权重计算 |
| `CalculateWeightResultCardMode` | [weight_card.go](../../../module/jili-game-server/service/reqservice/spinservice/weightrtp/weight_card.go) | 卡片模式权重计算 |

### 核心工具函数

| 函数名 | 文件位置 | 功能描述 |
|--------|----------|----------|
| `CalculatePerformanceResultOrigin` | [adjustcommon/util.go](../../../module/jili-game-server/service/reqservice/spinservice/adjustcommon/util.go) | 原始权重开奖 |
| `CalculateWeightIndex` | [adjustcommon/util.go](../../../module/jili-game-server/service/reqservice/spinservice/adjustcommon/util.go) | 权重随机选择 |
| `CalculateStatistic` | [adjustcommon/util.go](../../../module/jili-game-server/service/reqservice/spinservice/adjustcommon/util.go) | 计算统计量 |
| `CalculateCardRtp` | [adjustcommon/card.go](../../../module/jili-game-server/service/reqservice/spinservice/adjustcommon/card.go) | 计算卡片RTP |
| `adjustWeightListByMaxOddsWithBetTwdAmount` | [weight_max_odds.go](../../../module/jili-game-server/service/reqservice/spinservice/weightrtp/weight_max_odds.go) | 限制最大倍数（按投注金额） |
| `deductMaxOdds` | [weight_max_odds.go](../../../module/jili-game-server/service/reqservice/spinservice/weightrtp/weight_max_odds.go) | 消减最大倍数 |
| `distributeRtp2CandidateOdds` | [weight_max_odds.go](../../../module/jili-game-server/service/reqservice/spinservice/weightrtp/weight_max_odds.go) | 分配RTP给候选倍数 |
| `calculatePerformanceResultAdjustSd` | [weight_adjust_sd.go](../../../module/jili-game-server/service/reqservice/spinservice/weightrtp/weight_adjust_sd.go) | 调整标准差 |
| `deductVariance` | [weight_adjust_sd.go](../../../module/jili-game-server/service/reqservice/spinservice/weightrtp/weight_adjust_sd.go) | 消减方差 |

### 核心配置文件

| 文件名 | 文件位置 | 内容描述 |
|--------|----------|----------|
| `adjust.go` | [internal/entity/adjust.go](../../../module/jili-game-server/internal/entity/adjust.go) | 调整相关数据结构 |
| `adjust_config.go` | [internal/entity/adjust_config.go](../../../module/jili-game-server/internal/entity/adjust_config.go) | 调整配置数据结构 |
| `game.go` | [serverconst/game.go](../../../module/jili-game-server/serverconst/game.go) | 游戏模式常量定义 |
| `game_adjust.go` | [serverconst/game_adjust.go](../../../module/jili-game-server/serverconst/game_adjust.go) | 调控模式常量定义 |

---

## 配置说明

### rtpConfig.json 配置示例

每个游戏的调控配置存储在 `rtpConfig.json` 文件中，位于游戏资源目录下。

```json
{
  "rtpCtrConfig": {
    "currentRtp": 0.96,
    "rtpType2RtpMap": {
      "DYNAMIC_RTP_LOW": 0.94,
      "DYNAMIC_RTP_MIDDLE": 0.96,
      "DYNAMIC_RTP_HIGH": 0.98
    }
  },
  "performanceCtrConfig": {
    "rtpType2WeightOddsListMap": {
      "DYNAMIC_RTP_LOW": [
        {"odds": 0, "weight": 100},
        {"odds": 1, "weight": 200},
        {"odds": 5, "weight": 300},
        {"odds": 10, "weight": 200},
        {"odds": 50, "weight": 150},
        {"odds": 100, "weight": 50}
      ],
      "DYNAMIC_RTP_MIDDLE": [
        {"odds": 0, "weight": 100},
        {"odds": 1, "weight": 200},
        {"odds": 5, "weight": 300},
        {"odds": 10, "weight": 200},
        {"odds": 50, "weight": 150},
        {"odds": 100, "weight": 50}
      ],
      "DYNAMIC_RTP_HIGH": [
        {"odds": 0, "weight": 100},
        {"odds": 1, "weight": 200},
        {"odds": 5, "weight": 300},
        {"odds": 10, "weight": 200},
        {"odds": 50, "weight": 200},
        {"odds": 100, "weight": 100}
      ]
    },
    "weightPerformanceList": [
      [
        {"performanceIndex": 1, "weight": 100}
      ],
      [
        {"performanceIndex": 2, "weight": 50},
        {"performanceIndex": 3, "weight": 50}
      ],
      [
        {"performanceIndex": 4, "weight": 100}
      ],
      [
        {"performanceIndex": 5, "weight": 100}
      ],
      [
        {"performanceIndex": 6, "weight": 100}
      ],
      [
        {"performanceIndex": 7, "weight": 100}
      ]
    ]
  }
}
```

### 配置字段说明

#### rtpCtrConfig（RTP控制配置）

- **currentRtp**: 游戏的基础RTP（如0.96表示96%）
- **rtpType2RtpMap**: RTP类型映射表
  - `DYNAMIC_RTP_LOW`: 低RTP表的目标RTP
  - `DYNAMIC_RTP_MIDDLE`: 中RTP表的目标RTP
  - `DYNAMIC_RTP_HIGH`: 高RTP表的目标RTP

#### performanceCtrConfig（表演控制配置）

- **rtpType2WeightOddsListMap**: RTP类型到权重倍数列表的映射
  - 每个RTP类型对应一个倍数权重列表
  - `odds`: 倍数值
  - `weight`: 权重值（权重越高，出现概率越大）

- **weightPerformanceList**: 表演权重列表
  - 二维数组，第一维对应倍数索引，第二维是该倍数下的表演列表
  - `performanceIndex`: 表演索引（对应游戏中的具体表演效果）
  - `weight`: 权重值

### 商户配置

商户配置存储在数据库中，包括：

- **MerchantRtpStatus**: 商户RTP启用状态
- **MerchantRtp**: 商户自定义RTP
- **AdjustId**: 调控模式ID
  - 1: 自然不控
  - 2: 基本水池
  - 3: 新手扶持
- **WeightId**: 权重模式ID
  - 1: 原生权重
  - 2: 标准差1
  - 3: 标准差2
  - 4: 标准差3
  - 5: 直播算法
  - 6: 特色算法

### 用户配置

用户配置存储在数据库中，包括：

- **UserRtpStatus**: 用户RTP启用状态
- **UserRtp**: 用户自定义RTP
- **UserAdjustControl**: 用户调控记录
  - `TotalBetCount`: 总投注次数
  - `CurrentBetCount`: 当前周期投注次数
  - `ForceFeature`: 是否强制特色

---

- **GameModeCategory**: 游戏模式类别（Normal/Card/BuyFeature/Extra）
- **GameBetMode**: 投注模式（NormalBet/CardBet/ExtraBet01等）
- **AdjustID**: 调控模式（自然不控/基本水池/新手扶持）
- **WeightID**: 权重模式（原生/标准差1~3/直播/特色）
- **rtpType**: RTP表类型（HIGH/MIDDLE/LOW）

### 重要算法

1. **内插法选择RTP表**：根据目标RTP在多个RTP表中按概率选择
2. **权重随机算法**：根据权重列表随机选择索引
3. **标准差校正算法**：通过消减高倍数降低方差
4. **最大倍数限制**：根据投注金额限制最大倍数
5. **卡片RTP逼近**：调整权重以逼近卡片的目标RTP

### 关键文件

- 调整模块：[adjustmodule.go](../../../module/jili-game-server/service/reqservice/spinservice/adjustmodule.go)
- RTP计算：[adjust_flow.go](../../../module/jili-game-server/service/reqservice/spinservice/adjustrtp/adjust_flow.go)
- 权重计算：[weight_flow.go](../../../module/jili-game-server/service/reqservice/spinservice/weightrtp/weight_flow.go)
- 工具函数：[adjustcommon/util.go](../../../module/jili-game-server/service/reqservice/spinservice/adjustcommon/util.go)