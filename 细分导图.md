# 调控和结果计算流程思维导图

## 整体流程概览

```mermaid
graph TB
    A[开始 Spin 请求] --> B[CalculateAdjustRequest<br/>计算调控请求]
    B --> C[StartAdjust<br/>开始调控]
    C --> D[getTemplateBoardResultAndScale<br/>获取并缩放模板结果]
    D --> E[返回最终开奖结果]
    
    style B fill:#e1f5ff
    style C fill:#fff4e1
    style D fill:#e8f5e9
```

---

## 一、CalculateAdjustRequest - 计算调控请求

### 1.1 主流程
```mermaid
graph TB
    Start[CalculateAdjustRequest] --> A[获取上下文信息]
    A --> B[获取用户调控资料<br/>GetAdjustUserControl]
    B --> C[构建 BaseRequest<br/>基础请求参数]
    C --> D{游戏模式判断}
    D -->|Card 模式| E[筛选用户信息<br/>filterCurrentUserItemView]
    D -->|其他模式| F[继续]
    E --> F
    F --> G[构建 MerchantAdjust<br/>商家调控信息]
    G --> H[构建 UserAdjust<br/>用户调控信息]
    H --> I[获取调控配置<br/>GetAdjustConfig]
    I --> J[返回 AdjustRequest]
    
    style Start fill:#42a5f5
    style J fill:#66bb6a
```

### 1.2 关键数据结构
```mermaid
graph LR
    AdjustRequest[AdjustRequest] --> BaseRequest[BaseRequest<br/>基础请求]
    AdjustRequest --> MerchantPool[MerchantPool<br/>商家池子]
    AdjustRequest --> MerchantAdjust[MerchantAdjust<br/>商家调控]
    AdjustRequest --> UserAdjust[UserAdjust<br/>用户调控]
    AdjustRequest --> AdjustConfig[AdjustConfig<br/>调控配置]
    
    BaseRequest --> BR1[Cost 下注金额]
    BaseRequest --> BR2[GameCode 游戏编码]
    BaseRequest --> BR3[GameMode 游戏模式]
    BaseRequest --> BR4[GameBetMode 下注模式]
    BaseRequest --> BR5[UserItemView 卡片信息]
    
    MerchantAdjust --> MA1[MerchantRtpStatus]
    MerchantAdjust --> MA2[MerchantRtp]
    MerchantAdjust --> MA3[DynamicRealExchangeRate]
    MerchantAdjust --> MA4[AdjustID 调控类型]
    MerchantAdjust --> MA5[WeightID 权重类型]
    
    UserAdjust --> UA1[UserRtpStatus]
    UserAdjust --> UA2[UserRtp]
    UserAdjust --> UA3[UserAdjustControl<br/>用户调控控制]
```

---

## 二、StartAdjust - 开始调控处理

### 2.1 主流程
```mermaid
graph TB
    Start[StartAdjust] --> A[CalculateRtpType<br/>计算 RTP 类型]
    A --> B[CalculateWeightResult<br/>计算权重结果]
    B --> C[返回 AdjustResult<br/>调控结果]
    
    style Start fill:#42a5f5
    style A fill:#ffca28
    style B fill:#ff7043
    style C fill:#66bb6a
```

### 2.2 CalculateRtpType - 计算 RTP 类型

```mermaid
graph TB
    Start[CalculateRtpType] --> A{游戏模式判断}
    
    A -->|Card 模式| B[ChoseRtpTypeWithCard<br/>卡片调控]
    A -->|自然机率| C[ChoseRtpTypeRandom<br/>随机调控]
    A -->|调控模式| D[ChoseRtpTypeWithAdjustTypeAndMission<br/>任务调控]
    
    B --> B1[计算卡片 RTP<br/>CalculateCardRtp]
    B1 --> B2[内插法选择 RTP 类型<br/>ChooseRtpTypeByInterpolation]
    
    C --> C1[CalculateRtpByAdjustNormalFix<br/>固定机率计算]
    C1 --> C2[内插法选择 RTP 类型<br/>ChooseRtpTypeByInterpolation]
    
    D --> D1[CalculateTargetRtpWithAdjustTypeAndMission<br/>根据调控类型计算目标 RTP]
    D1 --> D2[扣除任务 RTP<br/>CalculateMissionRtp]
    D2 --> D3[内插法选择 RTP 类型<br/>ChooseRtpTypeByInterpolation]
    
    B2 --> Result[返回 RtpType]
    C2 --> Result
    D3 --> Result
    
    style Start fill:#42a5f5
    style Result fill:#66bb6a
```

### 2.3 CalculateTargetRtpWithAdjustTypeAndMission - 根据调控类型计算

```mermaid
graph TB
    Start[CalculateTargetRtpWithAdjustTypeAndMission] --> A{AdjustID 类型判断}
    
    A -->|AdjustNormalFix| B[CalculateRtpByAdjustNormalFix<br/>固定机率调控]
    A -->|AdjustNormalMerchantDynamic| C[CalculateRtpByAdjustNormalMerchantDynamic<br/>商家动态调控]
    A -->|AdjustNormalNewbie| D[CalculateRtpByAdjustNormalNewbie<br/>新手调控]
    A -->|其他| E[默认使用商家动态调控]
    
    B --> Result[返回目标 RTP]
    C --> Result
    D --> Result
    E --> Result
    
    style Start fill:#42a5f5
    style Result fill:#66bb6a
```

### 2.4 ChooseRtpTypeByInterpolation - 内插法选择 RTP 类型

```mermaid
graph TB
    Start[ChooseRtpTypeByInterpolation] --> A[findRtpRangeKeys<br/>找出目标 RTP 的上下界]
    A --> B{候选表数量}
    
    B -->|只有一个| C[直接返回该类型]
    B -->|有两个| D[计算内插概率 p]
    
    D --> E[p = targetRtp - lowerRtp / higherRtp - lowerRtp]
    E --> F[随机生成 0-1 随机数]
    F --> G{随机数 >= p?}
    
    G -->|是| H[返回 lowerKey<br/>较低 RTP 类型]
    G -->|否| I[返回 higherKey<br/>较高 RTP 类型]
    
    C --> Result[返回 RtpType]
    H --> Result
    I --> Result
    
    style Start fill:#42a5f5
    style Result fill:#66bb6a
    style E fill:#fff59d
```

### 2.5 CalculateWeightResult - 计算权重结果

```mermaid
graph TB
    Start[CalculateWeightResult] --> A{WeightID 类型判断}
    
    A -->|WeightNone| B[CalculateWeightNoneResult<br/>无权重]
    A -->|WeightSd1| C[CalculateWeightSd1Result<br/>标准差1]
    A -->|WeightSd2| D[CalculateWeightSd2Result<br/>标准差2]
    A -->|WeightSd3| E[CalculateWeightSd3Result<br/>标准差3]
    A -->|WeightStreamer| F[CalculateWeightStreamResult<br/>直播权重]
    A -->|WeightFeature| G[CalculateWeightFeatureResult<br/>Feature权重]
    A -->|其他| H[默认使用标准差3]
    
    B --> Result[返回 WeightResult]
    C --> Result
    D --> Result
    E --> Result
    F --> Result
    G --> Result
    H --> Result
    
    style Start fill:#42a5f5
    style Result fill:#66bb6a
```

### 2.6 CalculateWeightFeatureResult - Feature权重计算（详细）

```mermaid
graph TB
    Start[CalculateWeightFeatureResult] --> A[GetFeatureList<br/>获取Feature列表]
    A --> B{Feature列表存在?}
    
    B -->|不存在| C[calculateWeightResult<br/>performanceIndex = 0]
    B -->|存在| D[calculateTargetFeatureIndex<br/>计算目标Feature索引]
    
    D --> E[targetIndex = CurrentBetCount % len_featureList_<br/>依序表演]
    E --> F[取得 featureList_targetIndex_]
    F --> G[calculateWeightResult<br/>使用Feature索引]
    
    C --> Result[返回 WeightResult]
    G --> Result
    
    style Start fill:#42a5f5
    style Result fill:#66bb6a
    style E fill:#fff59d
```

### 2.7 calculateWeightResult - 核心权重计算

```mermaid
graph TB
    Start[calculateWeightResult<br/>rtpType, adjustConfig, performanceIndex] --> A[从配置获取权重赔率列表<br/>weightOddsList = RtpType2WeightOddsListMap_rtpType_]
    A --> B[遍历 WeightPerformanceList]
    B --> C{找到匹配的 performanceIndex?}
    
    C -->|找到| D[记录数组索引位置]
    C -->|未找到| E[继续遍历]
    
    E --> C
    D --> F[从 weightOddsList 获取对应赔率]
    F --> G[构建 WeightResult]
    
    G --> H[PerformanceResultArrayIndex]
    G --> I[OddsArrayIndex]
    G --> J[PerformanceIndex]
    G --> K[Odds 赔率]
    
    H --> Result[返回 WeightResult]
    I --> Result
    J --> Result
    K --> Result
    
    style Start fill:#42a5f5
    style Result fill:#66bb6a
    style G fill:#fff59d
```

---

## 三、getTemplateBoardResultAndScale - 获取并缩放模板结果

### 3.1 主流程
```mermaid
graph TB
    Start[getTemplateBoardResultAndScale] --> A{GameBetMode 判断}
    
    A -->|CardBet| B1[tableName = BoardResultCard]
    A -->|BuyFeatureBet01| B2[tableName = BoardResultBuy]
    A -->|ExtraBet01| B3[tableName = BoardResultExtra1]
    A -->|ExtraBet02| B4[tableName = BoardResultExtra2]
    A -->|NormalBet| B5[tableName = BoardResultNormal]
    
    B1 --> C[GetGameResult<br/>从数据库获取模板结果]
    B2 --> C
    B3 --> C
    B4 --> C
    B5 --> C
    
    C --> D[scaleTargetBoardResult<br/>缩放模板结果]
    D --> E[返回缩放后的结果 JSON]
    
    style Start fill:#42a5f5
    style D fill:#ff7043
    style E fill:#66bb6a
```

### 3.2 scaleTargetBoardResult - 缩放模板结果

```mermaid
graph TB
    Start[scaleTargetBoardResult<br/>templateBoardResult, spinCost, gameCode] --> A[转换为 JSON 格式]
    A --> B[GetGameScalePaths<br/>获取游戏缩放路径列表]
    B --> C[CalculateScaleFactor<br/>计算缩放因子]
    
    C --> D[scaleFactor = spinCost / templateBet]
    D --> E[更新 bet 路径为 spinCost]
    E --> F[ScaleExistingPaths<br/>对所有路径应用缩放因子]
    
    F --> G[遍历 uniqueScalePathList]
    G --> H[按缩放因子调整各路径的值]
    H --> I[返回缩放后的 JSON 字符串]
    
    style Start fill:#42a5f5
    style C fill:#fff59d
    style F fill:#ff7043
    style I fill:#66bb6a
```

---

## 四、完整流程整合

### 4.1 从 Spin 请求到开奖结果
```mermaid
graph TB
    Start[HandleSpin 处理游戏请求] --> Step1[解析 SpinReq 请求]
    Step1 --> Step2[验证请求合法性]
    Step2 --> Step3[计算下注成本 spinCost]
    Step3 --> Step4[CalculateAdjustRequest<br/>构建调控请求参数]
    
    Step4 --> Step5[StartAdjust<br/>执行调控逻辑]
    
    Step5 --> Sub5A[CalculateRtpType<br/>计算 RTP 类型]
    Sub5A --> Sub5B{游戏模式}
    Sub5B -->|卡片| Sub5C[卡片 RTP 计算]
    Sub5B -->|随机| Sub5D[固定机率计算]
    Sub5B -->|调控| Sub5E[任务调控计算]
    
    Sub5C --> Sub5F[内插法选择 RtpType]
    Sub5D --> Sub5F
    Sub5E --> Sub5G[扣除任务 RTP]
    Sub5G --> Sub5F
    
    Sub5F --> Sub5H[CalculateWeightResult<br/>计算权重结果]
    Sub5H --> Sub5I{WeightID 类型}
    Sub5I -->|Feature| Sub5J[Feature权重计算]
    Sub5I -->|其他| Sub5K[标准权重计算]
    
    Sub5J --> Sub5L[calculateWeightResult<br/>生成 PerformanceIndex 和 Odds]
    Sub5K --> Sub5L
    
    Sub5L --> Step6[返回 AdjustResult<br/>包含 WeightResult]
    
    Step6 --> Step7[getTemplateBoardResultAndScale<br/>获取开奖模板]
    
    Step7 --> Sub7A{GameBetMode}
    Sub7A --> Sub7B[选择对应表格]
    Sub7B --> Sub7C[GetGameResult<br/>根据 PerformanceIndex 查询]
    Sub7C --> Sub7D[scaleTargetBoardResult<br/>缩放结果]
    
    Sub7D --> Sub7E[计算缩放因子]
    Sub7E --> Sub7F[应用到所有路径]
    
    Sub7F --> Step8[返回缩放后的开奖结果 JSON]
    
    Step8 --> Step9[calculateRdx1AndRdx2<br/>生成注单索引]
    Step9 --> Step10[calculateBetAndWinAndNetWin<br/>计算金额]
    Step10 --> Step11[prepareTransaction<br/>准备写入数据库]
    Step11 --> Step12[doSpinTransaction<br/>执行写入数据库]
    Step12 --> Step13[calculateGaiaSpinResponse<br/>构建返回结果]
    Step13 --> End[返回给客户端]
    
    style Start fill:#1976d2
    style Step4 fill:#42a5f5
    style Step5 fill:#ffca28
    style Sub5F fill:#fff59d
    style Sub5H fill:#ff7043
    style Step7 fill:#66bb6a
    style Sub7D fill:#26a69a
    style End fill:#66bb6a
```

---

## 五、关键计算方法说明

### 5.1 核心方法列表

| 方法名 | 功能说明 | 输入 | 输出 |
|--------|----------|------|------|
| **CalculateAdjustRequest** | 构建调控请求参数 | SpinReq, 用户信息, 商家信息 | AdjustRequest |
| **StartAdjust** | 执行调控逻辑 | AdjustRequest | AdjustResult |
| **CalculateRtpType** | 计算 RTP 类型 | AdjustRequest | RtpType (string) |
| **ChoseRtpTypeWithCard** | 卡片模式 RTP 计算 | AdjustRequest | RtpType |
| **ChoseRtpTypeRandom** | 随机模式 RTP 计算 | AdjustRequest | RtpType |
| **ChoseRtpTypeWithAdjustTypeAndMission** | 任务调控 RTP 计算 | AdjustRequest | RtpType |
| **CalculateTargetRtpWithAdjustTypeAndMission** | 根据调控类型计算目标 RTP | AdjustRequest | targetRtp (float64) |
| **CalculateRtpByAdjustNormalFix** | 固定机率调控 | AdjustRequest | RTP |
| **CalculateRtpByAdjustNormalMerchantDynamic** | 商家动态调控 | AdjustRequest | RTP |
| **CalculateRtpByAdjustNormalNewbie** | 新手调控 | AdjustRequest | RTP |
| **CalculateMissionRtp** | 计算任务 RTP | - | missionRtp |
| **ChooseRtpTypeByInterpolation** | 内插法选择 RTP 类型 | rtpType2RtpMap, targetRtp | RtpType |
| **findRtpRangeKeys** | 找出目标 RTP 的上下界 | candidates, targetRtp | []rtpKeys |
| **CalculateWeightResult** | 计算权重结果（路由） | rtpType, AdjustRequest | WeightResult |
| **CalculateWeightFeatureResult** | Feature权重计算 | rtpType, AdjustRequest | WeightResult |
| **calculateTargetFeatureIndex** | 计算Feature索引（依序表演） | featureList, userAdjustControl | performanceIndex |
| **calculateWeightResult** | 核心权重计算 | rtpType, adjustConfig, performanceIndex | WeightResult |
| **getTemplateBoardResultAndScale** | 获取并缩放模板 | spinCost, gameBetMode, adjustResult | boardResultJson |
| **scaleTargetBoardResult** | 缩放模板结果 | templateBoardResult, spinCost, gameCode | boardResultJson |
| **CalculateScaleFactor** | 计算缩放因子 | templateBet, spinCost | scaleFactor |
| **ScaleExistingPaths** | 对路径应用缩放 | json, paths, scaleFactor | scaledJson |

### 5.2 数据流转示意

```mermaid
graph LR
    A[SpinReq] --> B[AdjustRequest]
    B --> C[RtpType]
    C --> D[WeightResult]
    D --> E[PerformanceIndex]
    E --> F[Template Result]
    F --> G[Scaled Board Result]
    G --> H[SpinResponse]
    
    style A fill:#e3f2fd
    style B fill:#fff3e0
    style C fill:#fff9c4
    style D fill:#f3e5f5
    style E fill:#e8f5e9
    style F fill:#fce4ec
    style G fill:#e0f2f1
    style H fill:#c8e6c9
```

---

## 六、关键配置和数据结构

### 6.1 AdjustConfig 调控配置

```
AdjustConfig
├── RtpCtrConfig (RTP 控制配置)
│   └── RtpType2RtpMap (RTP类型 -> RTP值 映射)
│       ├── "low": 0.85
│       ├── "medium": 0.95
│       └── "high": 0.98
│
└── PerformanceCtrConfig (表演控制配置)
    ├── RtpType2WeightOddsListMap (RTP类型 -> 权重赔率列表)
    │   ├── "low": [...]
    │   ├── "medium": [...]
    │   └── "high": [...]
    │
    └── WeightPerformanceList (权重表演列表)
        └── [[{PerformanceIndex: 1, Weight: 100}, ...], ...]
```

### 6.2 WeightResult 权重结果

```
WeightResult
├── PerformanceIndex (表演指标)
├── PerformanceResultArrayIndex (表演结果数组索引)
├── OddsArrayIndex (赔率数组索引)
└── Odds (赔率值)
```

### 6.3 AdjustResult 调控结果

```
AdjustResult
├── GameCode (游戏编码)
└── WeightResult (权重结果)
```

---

## 七、特殊逻辑说明

### 7.1 内插法（Interpolation）选择 RTP 类型

内插法用于在两个 RTP 类型之间进行概率选择，确保实际 RTP 更接近目标值。

**计算公式：**
```
p = (targetRtp - lowerRtp) / (higherRtp - lowerRtp)
```

**选择逻辑：**
- 生成随机数 `r ∈ [0, 1)`
- 如果 `r >= p`：选择 `lowerKey`（较低 RTP 类型）
- 如果 `r < p`：选择 `higherKey`（较高 RTP 类型）

**示例：**
```
假设：
- lowerRtp = 0.90 (RTP类型: "medium")
- higherRtp = 0.96 (RTP类型: "high")
- targetRtp = 0.94

计算：
- p = (0.94 - 0.90) / (0.96 - 0.90) = 0.04 / 0.06 ≈ 0.67

结果：
- 有 33% 概率选择 "medium"
- 有 67% 概率选择 "high"
- 期望 RTP ≈ 0.90 × 0.33 + 0.96 × 0.67 ≈ 0.94
```

### 7.2 Feature权重依序表演

对于 `WeightFeature` 类型，系统会依序展示特定的表演效果：

```
targetIndex = CurrentBetCount % len(featureList)
performanceIndex = featureList[targetIndex]
```

**示例：**
```
featureList = [10, 50, 100, 200]
CurrentBetCount = 7

计算：
- targetIndex = 7 % 4 = 3
- performanceIndex = featureList[3] = 200
```

### 7.3 缩放因子计算

确保模板结果与实际下注金额匹配：

```
scaleFactor = spinCost / templateBet

示例：
- templateBet = 1.0
- spinCost = 5.0
- scaleFactor = 5.0

结果：
- 所有金额相关字段（bet, win, totalWin 等）都会乘以 5.0
```

---

## 八、流程总结

### 8.1 三大阶段

1. **调控请求构建阶段**（CalculateAdjustRequest）
   - 收集用户、商家、游戏相关信息
   - 构建完整的调控请求参数

2. **调控计算阶段**（StartAdjust）
   - 根据调控类型计算目标 RTP
   - 使用内插法选择 RTP 类型
   - 根据权重类型计算表演指标

3. **结果生成阶段**（getTemplateBoardResultAndScale）
   - 根据表演指标获取模板结果
   - 根据实际下注金额缩放结果
   - 生成最终开奖结果

### 8.2 关键决策点

```mermaid
graph TD
    A[开始] --> B{游戏模式?}
    B -->|Card| C[使用卡片 RTP]
    B -->|其他| D{调控类型?}
    
    D -->|AdjustNormalFix| E[固定机率]
    D -->|AdjustNormalMerchantDynamic| F[商家动态]
    D -->|AdjustNormalNewbie| G[新手调控]
    
    C --> H[内插法选择 RtpType]
    E --> H
    F --> H
    G --> H
    
    H --> I{权重类型?}
    I -->|WeightFeature| J[Feature权重<br/>依序表演]
    I -->|其他| K[标准权重<br/>随机选择]
    
    J --> L[生成 PerformanceIndex]
    K --> L
    
    L --> M[获取模板结果]
    M --> N[缩放结果]
    N --> O[返回开奖]
    
    style A fill:#1976d2
    style B fill:#42a5f5
    style D fill:#42a5f5
    style H fill:#ffca28
    style I fill:#ff7043
    style O fill:#66bb6a
```

---

## 九、代码位置索引

| 功能模块 | 文件路径 |
|---------|---------|
| 主流程处理 | `spinservice/spin.go` |
| 调控模块 | `spinservice/adjustmodule.go` |
| RTP 类型计算 | `spinservice/adjustrtp/adjust_flow.go` |
| 内插法实现 | `spinservice/adjustrtp/interpolation.go` |
| 固定机率调控 | `spinservice/adjustrtp/adjust_normal_fix.go` |
| 商家动态调控 | `spinservice/adjustrtp/adjust_normal_merchant_dynamic.go` |
| 新手调控 | `spinservice/adjustrtp/adjust_normal_newbie.go` |
| 任务 RTP | `spinservice/adjustrtp/mission.go` |
| 权重计算路由 | `spinservice/weightrtp/weight_flow.go` |
| Feature权重 | `spinservice/weightrtp/weight_feature.go` |
| 卡片权重 | `spinservice/weightrtp/weight_card.go` |

---